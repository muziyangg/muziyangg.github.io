[{"content":"仪器配置图片 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 /// 名称: MI.MIFAU680 /// 描述: AU 680仪器接口 /// 通讯方式：双向 /// 编写者:liuzf /// 编写日期: 20150827 /// MIFAU680(mi) s mi=$g(mi) i \u0026#39;$l(mi) q s ^TMPMACHDATA1(mi,11)=mi s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),17) //端口号 //控制字符 SET $ZTRAP=\u0026#34;ErrHandler\u0026#34; s stx=$c(2),etx=$c(3),ack=$c(6),nak=$c(15),etb=$c(23),end=$c(5) s (epis,result,date,time,QC)=\u0026#34;\u0026#34; s ^TMPMACHDATA1(mi,10)=mi i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q s ^TMPMACH10(mi,50)=$h c Port q Main s record=$$Read^MI.MIF000(mi,stx,etb_\u0026#34;,\u0026#34;_etx) q:\u0026#39;$l(record) d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) ;d ACK //上传项目 //R 00002803 0169 1003007\u0026#34; //R 00000201 0059□□□□□□□□□□A010001815 //D 00000107 E207 E0970137.1r 098002.39r 0990105.3r \u0026#34; //S 003001 0173 1002947 E001002003004015\u0026#34; //S□000201□0059□□□□□□□□□□A010001815□□□□E027 //S□001101□0001□□□□□□□□□□1000000028□□□□E097098 //S□000801□0059□□□□□□□□□□A010009152□□□□E0270 //S□001101□0001□□□□□□□□□□1000000028□□□□E097098 //D□000508□0048□□□□□□□□□□□□A0139941□□□□E018009.56r□ //R□00000801□0059□□□□□□□□□□A010009152 //S 0000105 0007 A0060359 E002010013014015016045049054058092097098099 s texttype=$e(record,1,2) i texttype=\u0026#34;RH\u0026#34; d q .s epis=$tr($e(record,16,39),\u0026#34; \u0026#34;) .;s Pos=$e(record,5,41) .s Pos=$e(record,5,39) .s RackNo=$e(Pos,1,6) .d ReRequest i texttype=\u0026#34;R \u0026#34; d q .s epis=$tr($e(record,14,39),\u0026#34; \u0026#34;) .s Pos=$e(record,3,41) .s RackNo=$e(Pos,1,6) .///标本核收 .;s retVal=$$ReceiveLabno^MI.MIF000(mi,epis,RackNo) .;i retVal\u0026#39;=1 Quit .d SendTestItem //采集结果 i texttype=\u0026#34;D \u0026#34;!(texttype=\u0026#34;d \u0026#34;)!(texttype=\u0026#34;DQ\u0026#34;)!(texttype=\u0026#34;DH\u0026#34;)!(texttype=\u0026#34;dH\u0026#34;) d q .s block=$e(record,40) .s temstr=record .f temi=1:1:$l(temstr,etb) d ..s record=$p(temstr,etb,temi) ..i $e(record,1)=$c(2) s record=$p(record,$c(2),2) ..i \u0026#39;$l(record) q ..///D 00000101 E003 E15 288.5 ..///D 00003007 0153 1003005 E0010007.1r 0020016.8r 0030135.1r 0040017.6r 015006.21r \u0026#34; ..// D□00□□□□02□P002□□□□□□□□□□E030007032□□□□E0600053.4r□ ..// D□00000608□0063□□□□□□□□□□A010017861□□□□E019002.17r□020004.29r□022001.15r□023001.97r□024001.40r□025000.95r□0320068.4r□033405.67r□043001.01r□044002.05r□045002.36r□092001.18r□095001.17r□097000135r□0980006.9r□099000103r□ ..s res=$E(record,29,$l(record)) ..s (sample,epis,surname,result,date,time,QC)=\u0026#34;\u0026#34; ..s epis=$tr($e(record,14,25),\u0026#34; \u0026#34;) ..I \u0026#39;$L(epis) D ...S epis=$tr($e(record,10,13),\u0026#34; \u0026#34;) ..//流水号转条码号 ..i $l(epis)\u0026lt;5,epis\u0026#39;[\u0026#34;E\u0026#34; d ...s WorkGroupMachienDR=$lg(^dbo.BTMIMachineParameterD(mi),6) ...i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd(+$h,8),WorkGroupMachienDR,\u0026#34; \u0026#34;_epis)) q ...s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd(+$h,8),WorkGroupMachienDR,\u0026#34; \u0026#34;_epis,\u0026#34;\u0026#34;)) ...s VisitNumberDR=$lg(^dbo.RPVisitNumberReportD(ReportDR),2) ...s epis=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2) ..i texttype=\u0026#34;DQ\u0026#34; d ...s epis=$tr($e(record,24,27),\u0026#34; \u0026#34;) ...s epis=\u0026#34;Q\u0026#34;_epis ...;s QC=$e(record,45) ...;s QC=\u0026#34;QC\u0026#34;_QC,epis=QC ...;s QC=\u0026#34;\\\u0026#34;_epis ...;s res=$e(record,41,$l(record)) ..f j=1:14:$l(res) s rec=$e(res,j,j+13) q:rec=\u0026#34;\u0026#34; d ...s code=$e(rec,1,3),resx=+$tr($e(rec,4,14),\u0026#34; \u0026#34;),flag=$tr($e(rec,13,14),\u0026#34; \u0026#34;) ...S:resx?1\u0026#34;.\u0026#34;.N resx=\u0026#34;0\u0026#34;_resx ...s resx=$tr(resx,\u0026#34;GM\u0026#34;) ...i $e(resx,1,2)=\u0026#34;-.\u0026#34; s resx=\u0026#34;-0.\u0026#34;_$e(resx,3,$l(resx)) ...s result=result_code_ResultDeli_resx_ItemDeli .i $l(epis),$l(result) d //block=\u0026#34;E\u0026#34;, ..d Save^MI.MIF000(mi,epis,result,date,time,QC) ..s (sample,epis,surname,result,date,time,QC)=\u0026#34;\u0026#34; q LOAD ; i $d(^TMIF(mi,10)) k ^TMIF(mi,10) i $d(^TMP($zn,mi,\u0026#34;LL\u0026#34;)) k ^TMP($zn,mi,\u0026#34;LL\u0026#34;) //d loadlist^MIF000(mi) s (sx,line)=\u0026#34;\u0026#34; f s sx=^TMP($zn,mi,\u0026#34;LL1\u0026#34;,sx) q:sx=\u0026#34;\u0026#34; d .s send=^(sx) .s data=\u0026#34;S \u0026#34;_send_data .s line=$o(^TMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMIF(mi,10,line)=data q ; send \u0026#39;ack\u0026#39; to instrument ACK h 0.5 s ack=$c(6) w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q ; send string to instrument SAVE(mi) ; Create LoadList Records s (epis,samno,str)=\u0026#34;\u0026#34; s epis=^TMP(\u0026#34;MIF000\u0026#34;,$j,\u0026#34;LL\u0026#34;,\u0026#34;EPISODE\u0026#34;),epis=$j($p(epis,$c(1),1),20) s samno=+^TMP(\u0026#34;MIF000\u0026#34;,$j,\u0026#34;LL\u0026#34;,\u0026#34;SAMPLE\u0026#34;) s dumy=$j(\u0026#34; \u0026#34;,4),blockno=\u0026#34;E\u0026#34; s sex=$j(\u0026#34; \u0026#34;,1),age=$j(\u0026#34; \u0026#34;,3),month=$j(\u0026#34; \u0026#34;,2),pat=$j(\u0026#34; \u0026#34;,60) s patinfo=sex_age_month_pat s (z,test)=\u0026#34;\u0026#34; f s z=$o(^TMP(\u0026#34;MIF000\u0026#34;,$j,\u0026#34;LL\u0026#34;,\u0026#34;TEST\u0026#34;,z)) q:z=\u0026#34;\u0026#34; s test=test_z s str=epis_dummy_blockno_patinfo_test s ^TMP(\u0026#34;MIFCL900\u0026#34;,mi,\u0026#34;LL\u0026#34;,samno)=str q SEND ; s (x,str)=\u0026#34;\u0026#34; f s x=$o(^TMIF(mi,10,x)) q:x=\u0026#34;\u0026#34; d .s str=^(x) ;;f i=1:1:2 d q:ok .w stx_str_etx,*-3 d Trace^MI.MIF000(mi,str,\u0026#34;H--\u0026gt;M\u0026#34;) s str=\u0026#34;SE00\u0026#34; w stx_str_etx,*-3 d Trace^MI.MIF000(mi,str,\u0026#34;H--\u0026gt;M\u0026#34;) k ^TMP($zn,mi,\u0026#34;LL1\u0026#34;) q //d SendTestItem^MI.MIFAU680 SendTestItem s ItemChannel=\u0026#34;\u0026#34; ;s epis=\u0026#34;$$SearchTestItem^MI.MIFAU680(\u0026#34;A010017297\u0026#34;)\u0026#34; s ItemChannel=$$SearchTestItem(epis) ;s ItemChannel=\u0026#34;002010013014015016045049054058092097098099\u0026#34; ;s str=\u0026#34;S \u0026#34;_Pos_\u0026#34; \u0026#34;_\u0026#34; E\u0026#34;_ItemChannel s str=\u0026#34;S \u0026#34;_Pos_\u0026#34; \u0026#34;_\u0026#34; E\u0026#34;_ItemChannel //s str=\u0026#34;S \u0026#34;_Pos_\u0026#34; \u0026#34;_\u0026#34; E008005009\u0026#34; //ItemChannel //s str=\u0026#34;S 001101 0002 1000000030 E005008009\u0026#34; w stx_str_etx,*-3 d Trace^MI.MIF000(mi,str,\u0026#34;H--\u0026gt;M\u0026#34;) ;s str=\u0026#34;SE\u0026#34; ;w stx_str_etx,*-3 d Trace^MI.MIF000(mi,str,\u0026#34;H--\u0026gt;M\u0026#34;) ;r *a:5 d Trace^MI.MIF000(mi,$s($c(a)=ack:\u0026#34;ACK\u0026#34;,$c(a)=nak:\u0026#34;NAK\u0026#34;,1:$c(a)),\u0026#34;H\u0026lt;--M\u0026#34;) s epis=\u0026#34;\u0026#34; q ReRequest s ItemChannel=\u0026#34;\u0026#34; s str=\u0026#34;SH\u0026#34;_Pos_\u0026#34; \u0026#34;_\u0026#34; E\u0026#34;_ItemChannel w stx_str_etx,*-3 d Trace^MI.MIF000(mi,str,\u0026#34;H--\u0026gt;M\u0026#34;) s str=\u0026#34;SE\u0026#34; w stx_str_etx,*-3 d Trace^MI.MIF000(mi,str,\u0026#34;H--\u0026gt;M\u0026#34;) r *a:5 d Trace^MI.MIF000(mi,$s($c(a)=ack:\u0026#34;ACK\u0026#34;,$c(a)=nak:\u0026#34;NAK\u0026#34;,$c(a)=stx:\u0026#34;NAK\u0026#34;,1:$c(a)),\u0026#34;H\u0026lt;--M\u0026#34;) i $c(a)=stx w etx d Trace^MI.MIF000(mi,etx,\u0026#34;H--\u0026gt;M\u0026#34;) q SearchTestItem(epis) S tcx=\u0026#34;\u0026#34;,tc=\u0026#34;\u0026#34; d ScanOne^MI.MIF000(mi,epis) i $d(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis)) f N=1:1 s tc=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis,tc)) q:tc=\u0026#34;\u0026#34; d .I $L(tc)=2 D ..S tc=\u0026#34;0\u0026#34;_tc .I $L(tc)=3 D ..S tc=tc .I $L(tc)\u0026gt;=4 D ..S tc=$E(tc,2,4) .s tcx=tcx_tc Q tcx ErrHandler d Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) h 10 Q GetTestItem(mi) S mi=$G(mi) S tc=\u0026#34;\u0026#34;,tcs=\u0026#34;\u0026#34; F { S tc=$O(^TMIF(mi,2,tc)) Q:\u0026#39;$L(tc) S data=$G(^TMIF(mi,2,tc)) S flag=$P(data,\u0026#34;\\\u0026#34;,3) Continue:flag\u0026#39;=\u0026#34;Y\u0026#34; S chl=$P(data,\u0026#34;\\\u0026#34;,1) I $L(chl)\u0026gt;3 { S chl=$E(chl,2,$L(chl)) } S tcs=tcs_chl } Q tcs \u0026#34;\u0026#34;\u0026#34; ","date":"2024-12-30T00:00:00Z","image":"https://muziyangg.github.io/p/%E8%B4%9D%E5%85%8B%E6%9B%BCau680/assets/1_hu9205878883723159407.jpg","permalink":"https://muziyangg.github.io/p/%E8%B4%9D%E5%85%8B%E6%9B%BCau680/","title":"贝克曼AU680"},{"content":" 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 /// d ##class(MI.TEST.THBB).THBB(\u0026#34;3333133\u0026#34;) ClassMethod THBB(VisitNumberReportDR) { // 审核标本 ;s VisitNumberReportDR=\u0026#34;3333133\u0026#34; s Sessions=\u0026#34;1250216\u0026#34; s VisitNumberDR=lg(g(dbo.RPVisitNumberReportD(VisitNumberReportDR)),2) s VisitNumber=lg(g(dbo.RPVisitNumberD(VisitNumberDR)),2) w \u0026#34;处理标本:\u0026#34;_VisitNumber_\u0026#34;,报告ID为:\u0026#34;_VisitNumberReportDR,! d ..RecordGlobal(\u0026#34;处理标本:\u0026#34;_VisitNumber_\u0026#34;,报告ID为:\u0026#34;_VisitNumberReportDR) s Status=lg(g(dbo.RPVisitNumberReportD(VisitNumberReportDR)),22) i Status=\u0026#34;3\u0026#34; d QXSH s Status=lg(g(dbo.RPVisitNumberReportD(VisitNumberReportDR)),22) i ((Status=\u0026#34;5\u0026#34;)||(Status=\u0026#34;2\u0026#34;)) d FHDJ s Status=lg(g(^dbo.RPVisitNumberReportD(VisitNumberReportDR)),22) i Status\u0026#39;=1 q // 清除结果 // \u0026#34;3333126\u0026#34;,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;1250216\u0026#34; s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s ret=##class(LISSP.DHCRPVisitNumberReport).ClearResult(VisitNumberReportDR,Param,Sessions) i ret=1 d .w VisitNumber_\u0026#34;清除结果成功\u0026#34;,! .d ..RecordGlobal(VisitNumber_\u0026#34;清除结果成功\u0026#34;) ;b ;清除结果 // 回退标本 // \u0026#34;8000000023\u0026#34;,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;1\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P5\u0026gt;10.82.2.3\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;10221106\u0026lt;/P2\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;1250216\u0026#34; s TestSetDRs=\u0026#34;\u0026#34; s TestSetDR=\u0026#34;\u0026#34; f s TestSetDR=$o(dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; d .s TestSetDRs=TestSetDRs_\u0026#34;\u0026#34;_TestSetDR s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;1\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P5\u0026gt;10.82.2.3\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026#34;_TestSetDRs_\u0026#34;\u0026lt;/P2\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s ret=##Class(LISSP.DHCRPVisitNumber).RejectVisitNumber(VisitNumber,Param,Sessions) i ret=1 w \u0026#34;回退标本成功\u0026#34;,! ;b ;回退标本 q QXSH w VisitNumber_\u0026#34;该标本为审核状态，取消审核中\u0026#34;,! d ..RecordGlobal(VisitNumber_\u0026#34;该标本为审核状态，取消审核中\u0026#34;) // 取消审核 // \u0026#34;3333180\u0026#34;,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;2\u0026lt;/P3\u0026gt;\u0026lt;P1\u0026gt;1\u0026lt;/P1\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;72\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;10.82.2.3\u0026lt;/P2\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;1250216\u0026#34; s WorkGroupMachineDR=lg(g(dbo.RPVisitNumberReportD(VisitNumberReportDR)),4) i \u0026#39;$l(WorkGroupMachineDR) s WorkGroupMachineDR=\u0026#34;-1\u0026#34; s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;2\u0026lt;/P3\u0026gt;\u0026lt;P1\u0026gt;1\u0026lt;/P1\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_WorkGroupMachineDR_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;10.82.2.3\u0026lt;/P2\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s ret=##class(LISSP.DHCRPVisitNumberReport).ReportUndo(VisitNumberReportDR,Param,Sessions) s successFlag=$p(ret,\u0026#34;\u0026#34;,1) i ret\u0026#39;=1 q w VisitNumber_\u0026#34;取消审核成功\u0026#34;,! d ..RecordGlobal(VisitNumber_\u0026#34;取消审核成功\u0026#34;) q FHDJ w VisitNumber_\u0026#34;将标本返回登记状态\u0026#34;,! d ..RecordGlobal(VisitNumber_\u0026#34;将标本返回登记状态\u0026#34;) // 返回登记 s Status=lg(g(^dbo.RPVisitNumberReportD(VisitNumberReportDR)),22) s objReport=##class(dbo.RPVisitNumberReport).%OpenId(VisitNumberReportDR) s objReport.Status=\u0026#34;1\u0026#34; s rc=objReport.%Save() q } /// d ##class(MI.TEST.THBB).SearchVisitNumber() ClassMethod SearchVisitNumber() { // IndexRequestDate RPVisitNumber HospitalDR, RequestDate s RequestDate=\u0026#34;\u0026#34; f s RequestDate=$o(dbo.RPVisitNumberI(\u0026#34;IndexRequestDate\u0026#34;,16,RequestDate)) q:RequestDate=\u0026#34;\u0026#34; d .s VisitNumberDR=\u0026#34;\u0026#34; f s VisitNumberDR=$o(dbo.RPVisitNumberI(\u0026#34;IndexRequestDate\u0026#34;,16,RequestDate,VisitNumberDR)) q:VisitNumberDR=\u0026#34;\u0026#34; d ..d ReportInfo q ReportInfo s fWorkGPMiDR=\u0026#34;\u0026#34; f s fWorkGPMiDR=$o(dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,fWorkGPMiDR)) q:fWorkGPMiDR=\u0026#34;\u0026#34; d .s fOrderNo=\u0026#34;\u0026#34; f s fOrderNo=$o(dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,fWorkGPMiDR,fOrderNo)) q:fOrderNo=\u0026#34;\u0026#34; d ..s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,fWorkGPMiDR,fOrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d ...d ..THBB(ReportDR) q ReportInfo1 s fWorkGPMiDR=\u0026#34;76\u0026#34; s fOrderNo=\u0026#34;\u0026#34; f s fOrderNo=$o(dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,fWorkGPMiDR,fOrderNo)) q:fOrderNo=\u0026#34;\u0026#34; d .s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,fWorkGPMiDR,fOrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d ..d ..THBB(ReportDR) q } ClassMethod RecordGlobal(str) { i \u0026#39;$d(LISTMPData(\u0026#34;THBB\u0026#34;)) d .s Num=1 e s Num=$o(LISTMPData(\u0026#34;THBB\u0026#34;,\u0026#34;\u0026#34;),-1)+1 s DateTime=zdt(h,8) s ^LISTMPData(\u0026#34;THBB\u0026#34;,Num,DateTime)=str q } ","date":"2024-12-30T00:00:00Z","image":"https://muziyangg.github.io/p/blog-post-slug/title_hu12327715643220330202.jpg","permalink":"https://muziyangg.github.io/p/blog-post-slug/","title":"批量取消审核"},{"content":"结果异常改变打印颜色 HIS.DHCReportPrint\n在此处添加异常结果信息\n更新模板所有字段 HIS.DHCReportPrintBase\nlis 设置默认打印机 HIS.DHCReportPrintBarCode\n1.设置打印机名称为 tiaoma\n2.创建打印机副本命名为条码\n3.修改代码默认打印机名称\n模板设计器增加可用元素 HIS.DHCReportPrint // 添加可用参数\nHIS.DHCReportPrintBase //更新 global\n初始化字符串位置\n拼接 RetStr 字符串\n保存标本登记存储过程 LISSP.DHCRPVisitNumber\n接收用户提示不存在\n自动任务（lis 和 his 信息同步，拒收） TASK.LisRealTimeInterface\nw ##Class(TASK.LISRealTimeTask).Do()\n##Class(LISAPP.TASK.LisRealTimeInterface).Do()#\n同步 his 数据 LIS.Util.SyncData\n同步病区和科室数据，利用sql进行数据同步\n标本接收核收 （LISSP.DHCRPVisitNumber).ReceiveVisitNumber\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Param.P0 C:集中接收 H:核收 Param.P1检测号(流水号/条码号) Param.P2细菌鉴定号 Param.P3流水号 Param.P4核收者 Param.P5接收备注ReceiveNotes Param.P6接收质量SpecimenQualityDR Param.P7接收医嘱列表VisTSDRLists Param.P8工作小组idWorkGroupMachineDR Param.P9 CarryUserDR Param.P10接收时间TransmitDate Param.P11 CheckTestSetDRList Param.P12 RackNo Param.P13接收IP Param.P14 ExParaList 格式：送达人信息@ w ##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(\u0026#34;1000253031\u0026#34;,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P11\u0026gt;@\u0026lt;/P11\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P14\u0026gt;@\u0026lt;/P14\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;10.20.25.174\u0026lt;/P13\u0026gt;\u0026lt;P0\u0026gt;H\u0026lt;/P0\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P3\u0026gt;22\u0026lt;/P3\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P10\u0026gt;2023-08-23\u0026lt;/P10\u0026gt;\u0026lt;P8\u0026gt;6\u0026lt;/P8\u0026gt;\u0026lt;P4\u0026gt;11627\u0026lt;/P4\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;11627^4^0^13^1\u0026#34;) BS 标本接收 HIS.DHCReceiveWebService——ReceiveAllHIS\nHIS.DHCReceiveProcess——ReceiveAllBS\nHIS.DHCReceiveCommon——CheckSampleInfo\n标本审核 w ##Class(LISSP.DHCRPVisitNumberReport).SaveResult(\u0026ldquo;2507\u0026rdquo;,\u0026quot; A ^^^^^81^^^^^^^^^ 127.0.0.1 611^^1017^^测试^^^^^^^^A^^^^*10~9/L^^^^4^^^^^^2017-11-01^^09:02:32^^1^^^^^^^^^^^^^^^^^^2507@@ \u0026ldquo;,\u0026rdquo; 11327^^21 \u0026ldquo;)\n微生物审核 LIS.WS.BLL.DHCRPMicReportSave\n/// w ##Class(IDP.WS.BLL.DHCIDPResult).EndIDPReportMTHD(\u0026ldquo;1597887@715\u0026rdquo;, \u0026ldquo;3\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;8280\u0026rdquo;, \u0026ldquo;11521\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;1159540161\u0026rdquo;)\n保存条码医嘱信息 HIS.DHCReceiveCommon——SaveLabNoTSInfo\n//签收生成上传信息\n报告处理页面功能 (检验)LIS.WS.BLL.DHCRPReportManage.QryWorkList\n(微生物)LIS.WS.BLL.DHCRPMicNumberReport.QryLabInformatin\n参考范围方法 LISSP.BLL.DHCCommonInterface\n保存标本登记存储过程 LISSP.DHCRPVisitNumber\n首页功能显示 LISSTAT.LIS.QryST.HomePage\n报告查询 老 LIS.WS.BLL.DHCRPQueryReport\n新 LIS.WS.BLL.DHCReportQuery\n新 LIS.WS.BLL.DHCLISReportPrint\t自助程序\n标本状态查询 LIS.WS.BLL.DHCStatSample\n输血打印 申请单 HIS.DHCReportPrintReqForm\n发血单 HIS.DHCReportPrintXM\n审批单 HIS.DHCBDPrintBigReqform\n配血单 HIS.DHCReportPrintXMMethod\n取血单 HIS.DHCReportPrintTakeRecordPack\n服务器问题弹窗 LIS.WS.DHCLISServiceBase\n获取工作小组最大流水号 w ##class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(\u0026ldquo;12\u0026rdquo;)\n通过编号规则获取流水号 编号规则面向所有需要编号的业务提供服务，只需要维护规则业务调用接口得到编号即可，走号不与业务耦合 调用接口, 通过规则主键得到下一号: w ##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(\u0026ldquo;1\u0026rdquo;) 调用接口, 通过规则代码得到下一号: w ##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(\u0026ldquo;001\u0026rdquo;, \u0026ldquo;\u0026rdquo;) 调用接口, 取消号的使用释放可用号: w ##class(LIS.WS.BLL.DHCLISRuleNo).CancelNoUse(\u0026rdquo;\u0026quot;, \u0026ldquo;\u0026quot;)或 CancelNoUseByRowIDMTHD(\u0026rdquo;\u0026quot;, \u0026ldquo;\u0026rdquo;)\n自动核收方法 w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGMWithMsg(\u0026ldquo;4\u0026rdquo;, \u0026ldquo;1000100975\u0026rdquo;, \u0026ldquo;\u0026rdquo;)\n///标本核收 s retVal =$$ReceiveLabno^MI.MIF000(mi, epis, RackNo) i retVal\u0026rsquo;= 1 Quit\n检验公共消息接口 d ##Class(TASK.LISRealTimeTask).Do()\n检验仪器自启任务 d ##Class(MI.Common.MachineControl).StartAll()\n主动上传方法 复查 LIS.Common.DHCVisitNumber\u0026ndash;CreateUploadRecordMTHD\n拒收 LISSP.DHCRPVisitNumber\u0026ndash;RejectVisitNumber\n外送方法 LIS.Service.ENS.SaveReport\n查询 his 用户信息 LIS.WS.BLL.HISSSUser\n根据就诊号, 化验项目, 审核日期查询对照码结果 web.DHCENS.STBLL.Method.GetResult\n标本状态查询 d ##Class(%ResultSet).RunQuery(\u0026ldquo;LIS.WS.BLL.DHCStatSample\u0026rdquo;, \u0026ldquo;QryStatSample\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;9000000762\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;20\u0026rdquo;, \u0026ldquo;1\u0026rdquo;, \u0026ldquo;11370121\u0026rdquo;)\n回退拒收标本 w ##Class(LISSP.DHCRPVisitNumber).RejectVisitNumber(\u0026ldquo;00000000574\u0026rdquo;, \u0026ldquo; 5 ​\u0026lt;/P2\u0026gt;​ ​\u0026lt;P10\u0026gt;​ ​\u0026lt;/P10\u0026gt;​ ​\u0026lt;P11\u0026gt;​ ​\u0026lt;/P11\u0026gt;​ ​\u0026lt;P13\u0026gt;​ ​\u0026lt;/P13\u0026gt;​ ​\u0026lt;P4\u0026gt;​ ​\u0026lt;/P4\u0026gt;​ ​\u0026lt;P14\u0026gt;​ ​\u0026lt;/P14\u0026gt;​ ​\u0026lt;P0\u0026gt;​ 19 ​\u0026lt;/P0\u0026gt;​ ​\u0026lt;P1\u0026gt;​ ​\u0026lt;/P1\u0026gt;​ ​\u0026lt;P9\u0026gt;​ ​\u0026lt;/P9\u0026gt;​ ​\u0026lt;P7\u0026gt;​ ​\u0026lt;/P7\u0026gt;​ ​\u0026lt;P5\u0026gt;​ 113.140.81.66 ​\u0026lt;/P5\u0026gt;​ ​\u0026lt;/Data\u0026gt;​\u0026quot;, \u0026quot;1137012^1\u0026rdquo;)\nHIS 导入数据 DHCLIS.DHCBTData\n查询仪器监控数据 \u0026ldquo;LIS.WS.BLL.DHCMachineParameter\u0026rdquo;, \u0026ldquo;QryMachineTransferResult\u0026rdquo;\n^TMPMACHRESULT(MachID, SttDate),-1)\n标本核收界面通过登记号查询信息 /// d ##Class(%ResultSet).RunQuery(\u0026ldquo;LIS.WS.BLL.DHCHisOrderItem\u0026rdquo;, \u0026ldquo;QryHisOrderItemListByRegNo\u0026rdquo;, \u0026ldquo;0000000006\u0026rdquo;, \u0026ldquo;13\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;\u0026rdquo;, \u0026ldquo;82803021\u0026rdquo;)\n基础数据查询公用方法 LIS.WS.BLL.DHCLISBaseCore\n推送 otmsg 消息 LISSP.BLL.DHCOTMsgStock\t微生物审核调用 LISSP.BLL.DealMsgQueue\t普通审核调用\n定时任务 【dhc-app】web.DHCLisRealTimeInterface\nd ##Class(LIS.WS.DHCLISServiceBase).ManaInvoke(\u0026ldquo;TASK.LISRealTimeTask\u0026rdquo;, \u0026ldquo;Do\u0026rdquo;) 新\n报表授权 zn \u0026ldquo;%sys\u0026rdquo;\nd ##class(BSP.SMP.DHCManageRolesAndUsers).GrantRolesSQLPrivilege()\n保存危急值处理消息 w ##Class(DHCLIS.DHCCommon).SaveTransPanicNotice(37, \u0026ldquo;01697\u0026rdquo;, \u0026ldquo;fasf231312^afdafsa\u0026rdquo;, \u0026ldquo;\u0026rdquo;)\n‍\n","date":"2024-12-29T00:00:00Z","image":"https://muziyangg.github.io/img/title.jpg","permalink":"https://muziyangg.github.io/p/%E5%8A%9F%E8%83%BD%E5%AF%B9%E5%BA%94%E8%B7%AF%E5%BE%84/","title":"功能对应路径"}]